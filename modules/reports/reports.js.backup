window.ReportsModule = {
    async renderList(container) {
        container.innerHTML = `
            <div class="reports-header">
                <h2>Registro P√∫blico de Infieles</h2>
                <div class="reports-controls">
                    <input type="text" id="searchReports" class="search-input" placeholder="Buscar por nombre, ciudad...">
                    <button class="btn btn-primary" onclick="window.location.hash='#/registrar'">+ Registrar Infiel</button>
                </div>
            </div>
            <div id="reportsTableContainer" class="reports-table-container">
                <div class="loader"></div>
            </div>
            <!-- Modal Container -->
            <div id="reportModal" class="modal-overlay">
                <div class="modal-content">
                    <button class="modal-close" onclick="window.ReportsModule.closeModal()">&times;</button>
                    <div id="modalBody"></div>
                </div>
            </div>
        `;

        try {
            const data = await Api.get('/reports?country=PE');
            this.renderTable(data.reports || []);
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('reportsTableContainer').innerHTML =
                `<p class="text-center" style="color:var(--color-error)">Error cargando reportes: ${error.message}</p>`;
        }
    },

    renderTable(reports) {
        const container = document.getElementById('reportsTableContainer');

        if (reports.length === 0) {
            container.innerHTML = '<p class="text-center" style="padding: 2rem;">No hay reportes registrados a√∫n.</p>';
            return;
        }

        let html = `
            <table class="reports-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Ubicaci√≥n</th>
                        <th>Edad</th>
                        <th>Ocupaci√≥n</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
        `;

        reports.forEach(report => {
            html += `
                <tr onclick="window.ReportsModule.openDetail('${report._id}')">
                    <td>
                        <strong>${report.reportedName} ${report.reportedLastName}</strong>
                    </td>
                    <td>${report.city || '-'}, ${report.department}</td>
                    <td>${report.age}</td>
                    <td>${report.occupation}</td>
                    <td>
                        <span class="status-badge status-${report.status}">${this.translateStatus(report.status)}</span>
                    </td>
                    <td>
                        <button class="btn btn-outline" style="padding: 2px 8px; font-size: 0.7rem;">Ver</button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    },

    async openDetail(reportId) {
        // Redirect to thread view
        window.location.hash = `#/hilo/${reportId}`;
    },

    async renderThread(container, reportId) {
        container.innerHTML = '<div class="loader"></div>';

        try {
            const report = await Api.get(`/reports/${reportId}`);

            modalBody.innerHTML = `
                <div class="case-header">
                    <div>
                        <h2 class="case-title">${report.reportedName} ${report.reportedLastName}</h2>
                        <div class="case-meta">
                            Reportado el ${new Date(report.createdAt).toLocaleDateString()} en ${report.city || report.department}
                        </div>
                    </div>
                    <span class="status-badge status-${report.status}" style="font-size: 1rem;">${this.translateStatus(report.status)}</span>
                </div>

                <div class="case-body">
                    <div class="case-details">
                        <h3>Detalles del Caso</h3>
                        <p><strong>Edad:</strong> ${report.age} a√±os</p>
                        <p><strong>Ocupaci√≥n:</strong> ${report.occupation}</p>
                        <p><strong>Ubicaci√≥n:</strong> ${report.district}, ${report.department}</p>
                        
                        <div class="mt-1">
                            <h4>Pruebas Adjuntas</h4>
                            <div class="evidence-gallery">
                                ${report.evidence && report.evidence.length > 0
                    ? report.evidence.map(e => `<img src="${e.url}" class="evidence-img" alt="Prueba">`).join('')
                    : '<p class="text-muted">No hay pruebas visuales p√∫blicas.</p>'}
                            </div>
                        </div>

                        <div class="mt-2">
                            <h4>Historial de Verificaci√≥n</h4>
                            <p>Este reporte ha sido confirmado por <strong>${report.verificationScore}</strong> persona(s).</p>
                            <button class="btn btn-primary mt-1" onclick="window.ReportsModule.verify('${report._id}')">Confirmar que lo conozco</button>
                        </div>
                    </div>

                    <div class="case-actions">
                        <div style="background: #f9f9f9; padding: 1rem; border-radius: 4px;">
                            <h4>¬øEres t√∫?</h4>
                            <p style="font-size: 0.9rem; margin-bottom: 1rem;">Si crees que este reporte es falso, puedes iniciar una disputa formal.</p>
                            <button class="btn btn-outline" style="width: 100%;" onclick="window.ReportsModule.startDispute('${report._id}')">Refutar Reporte</button>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            modalBody.innerHTML = '<p class="error">Error cargando detalles.</p>';
        }
    },

    closeModal() {
        document.getElementById('reportModal').classList.remove('active');
    },

    navigateToCreate() {
        // Simple navigation for now
        window.location.pathname = '/reportar';
    },

    renderForm(container) {
        container.innerHTML = `
            <div style="max-width: 600px; margin: 0 auto;">
                <h2>Registrar Infiel</h2>
                <p class="mb-2">Ayuda a la comunidad reportando casos verificables de infidelidad.</p>
                
                <form id="createReportForm" onsubmit="window.ReportsModule.submitReport(event)">
                    <div class="form-group">
                        <label class="form-label">Nombres</label>
                        <input type="text" name="reportedName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Apellidos</label>
                        <input type="text" name="reportedLastName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Departamento</label>
                        <input type="text" name="department" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Distrito</label>
                        <input type="text" name="district" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Edad Aproximada</label>
                        <input type="number" name="age" class="form-input" required min="18">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ocupaci√≥n</label>
                        <input type="text" name="occupation" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Evidencias (Opcional)</label>
                        <input type="file" id="evidenceFiles" accept="image/*" multiple class="form-input" 
                               onchange="window.ReportsModule.previewEvidence(event)">
                        <small style="color: var(--color-text-muted); display: block; margin-top: 4px;">
                            M√°ximo 5 im√°genes, 2MB cada una. Formatos: JPG, PNG
                        </small>
                        <div id="evidencePreview" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Informaci√≥n Adicional (Opcional)</label>
                        <textarea name="additionalInfo" class="form-textarea" maxlength="2000" 
                                  placeholder="Describe la situaci√≥n, contexto, o cualquier informaci√≥n relevante..."></textarea>
                        <small style="color: var(--color-text-muted);">
                            <span id="infoCharCount">0</span>/2000 caracteres
                        </small>
                    </div>
                    
                    <div class="form-group mt-2">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Registrar Infiel</button>
                    </div>
                </form>
            </div>
        `;

        // Character counter
        setTimeout(() => {
            const textarea = document.querySelector('textarea[name="additionalInfo"]');
            const charCount = document.querySelector('#infoCharCount');
            if (textarea && charCount) {
                textarea.addEventListener('input', () => {
                    charCount.textContent = textarea.value.length;
                });
            }
        }, 100);
    },

    previewEvidence(event) {
        const files = event.target.files;
        const preview = document.getElementById('evidencePreview');
        preview.innerHTML = '';

        if (files.length > 5) {
            window.Toast.error('M√°ximo 5 im√°genes permitidas');
            event.target.value = '';
            return;
        }

        Array.from(files).forEach(file => {
            if (file.size > 2 * 1024 * 1024) {
                window.Toast.error(`${file.name} es demasiado grande. M√°ximo 2MB por imagen.`);
                event.target.value = '';
                preview.innerHTML = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid var(--color-border);';
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    },

    async submitReport(event) {
        event.preventDefault();
        
        // Check if user is logged in
        if (!window.Auth.isLoggedIn()) {
            window.Toast.warning('Debes iniciar sesi√≥n para registrar un infiel. Redirigiendo...', 3000);
            setTimeout(() => {
                window.location.hash = '#/login';
            }, 1500);
            return;
        }

        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Process evidence files
        const files = document.getElementById('evidenceFiles').files;
        const evidence = [];

        for (let file of files) {
            if (file.size > 2 * 1024 * 1024) {
                window.Toast.error(`${file.name} supera el l√≠mite de 2MB`);
                return;
            }
            const base64 = await this.fileToBase64(file);
            evidence.push(base64);
        }

        data.evidence = evidence;
        data.deviceFingerprint = window.DeviceFingerprint.generate();
        data.age = parseInt(data.age);

        try {
            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Enviando...';
            
            await Api.post('/reports', data);
            
            window.Sound.playSuccess();
            window.Toast.success('¬°Infiel registrado exitosamente! El reporte est√° ahora p√∫blico.');
            
            setTimeout(() => {
                window.location.hash = '#/perfil';
            }, 1500);
        } catch (error) {
            let errorMsg = 'Error al enviar el reporte.';
            if (error.message.includes('l√≠mite')) {
                errorMsg = 'Has alcanzado el l√≠mite de reportes diarios (3). Intenta ma√±ana.';
            } else if (error.message) {
                errorMsg = error.message;
            }
            window.Toast.error(errorMsg);
            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = false;
            btn.textContent = 'Registrar Infiel';
        }
    },

    fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },

    translateStatus(status) {
        const map = {
            'pending': 'Pendiente',
            'verified': 'Verificado',
            'disputed': 'En Disputa',
            'rejected': 'Rechazado'
        };
        return map[status] || status;
    }
};


            container.innerHTML = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <button class="btn btn-outline" onclick="window.location.hash='#/'" style="margin-bottom: 1rem;">
                        ‚Üê Volver a la lista
                    </button>

                    <div class="case-header" style="background: white; padding: 2rem; border-radius: 4px; margin-bottom: 2rem;">
                        <h2>${report.reportedName} ${report.reportedLastName}</h2>
                        <p style="color: var(--color-text-muted);">
                            ${report.age} a√±os ‚Ä¢ ${report.occupation} ‚Ä¢ ${report.district}, ${report.department}
                        </p>
                        <div style="display: flex; gap: 10px; margin-top: 1rem;">
                            <span class="status-badge status-${report.status}">${this.translateStatus(report.status)}</span>
                            <span class="status-badge" style="background: #e3f2fd; color: #1976d2;">
                                ${report.communityStatus || 'Pendiente'}
                            </span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <strong>Verificaciones:</strong> ${report.verificationScore} persona(s)
                        </div>
                        ${report.additionalInfo ? `
                            <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                                <strong>Informaci√≥n adicional:</strong>
                                <p style="margin-top: 0.5rem;">${report.additionalInfo}</p>
                            </div>
                        ` : ''}
                        ${report.evidence && report.evidence.length > 0 ? `
                            <div style="margin-top: 1rem;">
                                <strong>Evidencias:</strong>
                                <div style="display: flex; gap: 10px; margin-top: 0.5rem; flex-wrap: wrap;">
                                    ${report.evidence.map(e => `
                                        <img src="${e.url}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 4px; cursor: pointer;" 
                                             onclick="window.open('${e.url}', '_blank')">
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div style="background: white; padding: 2rem; border-radius: 4px;">
                        <h3>Opiniones de la Comunidad</h3>
                        <p style="color: var(--color-text-muted); margin-bottom: 2rem;">
                            Comparte tu opini√≥n y evidencia. La comunidad decidir√° la veracidad del reporte.
                        </p>

                        <div id="commentForm" style="margin-bottom: 2rem; padding: 1.5rem; background: #f9f9f9; border-radius: 4px;">
                            <h4>Tu Opini√≥n</h4>
                            <div style="margin: 1rem 0;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">¬øQu√© opinas?</label>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-outline" id="voteAgree" onclick="window.ReportsModule.selectVote('agree')" 
                                            style="flex: 1; background: white;">
                                        üëç De acuerdo
                                    </button>
                                    <button class="btn btn-outline" id="voteDisagree" onclick="window.ReportsModule.selectVote('disagree')" 
                                            style="flex: 1; background: white;">
                                        üëé En desacuerdo
                                    </button>
                                    <button class="btn btn-outline" id="voteNeutral" onclick="window.ReportsModule.selectVote('neutral')" 
                                            style="flex: 1; background: white;">
                                        ü§∑ Neutral
                                    </button>
                                </div>
                            </div>
                            <textarea id="commentContent" placeholder="Comparte tu experiencia, opini√≥n o informaci√≥n adicional..." 
                                      style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
                                      maxlength="1000"></textarea>
                            <small style="color: var(--color-text-muted); display: block; margin-top: 4px;">
                                <span id="commentCharCount">0</span>/1000 caracteres
                            </small>
                            <button class="btn btn-primary" onclick="window.ReportsModule.submitComment('${reportId}')" style="margin-top: 1rem;">
                                Publicar Opini√≥n
                            </button>
                        </div>

                        <div id="commentsContainer">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            `;

            // Character counter
            const textarea = document.getElementById('commentContent');
            const charCount = document.getElementById('commentCharCount');
            textarea.addEventListener('input', () => {
                charCount.textContent = textarea.value.length;
            });

            // Load comments
            this.loadComments(reportId);

        } catch (error) {
            container.innerHTML = `<p style="color: var(--color-error);">Error: ${error.message}</p>`;
        }
    },

    selectedVote: null,

    selectVote(vote) {
        this.selectedVote = vote;
        document.getElementById('voteAgree').style.background = vote === 'agree' ? '#4caf50' : 'white';
        document.getElementById('voteAgree').style.color = vote === 'agree' ? 'white' : 'inherit';
        document.getElementById('voteDisagree').style.background = vote === 'disagree' ? '#f44336' : 'white';
        document.getElementById('voteDisagree').style.color = vote === 'disagree' ? 'white' : 'inherit';
        document.getElementById('voteNeutral').style.background = vote === 'neutral' ? '#ff9800' : 'white';
        document.getElementById('voteNeutral').style.color = vote === 'neutral' ? 'white' : 'inherit';
    },

    async submitComment(reportId) {
        if (!window.Auth.isLoggedIn()) {
            window.Toast.warning('Debes iniciar sesi√≥n para comentar');
            setTimeout(() => window.location.hash = '#/login', 1000);
            return;
        }

        if (!this.selectedVote) {
            window.Toast.error('Selecciona tu opini√≥n (De acuerdo, En desacuerdo o Neutral)');
            return;
        }

        const content = document.getElementById('commentContent').value.trim();
        if (!content) {
            window.Toast.error('Escribe tu opini√≥n');
            return;
        }

        const user = window.Auth.getUser();
        const data = {
            userId: user.userId,
            userName: user.name,
            content,
            vote: this.selectedVote
        };

        try {
            await Api.post(`/comments/${reportId}`, data);
            window.Toast.success('Opini√≥n publicada exitosamente');
            document.getElementById('commentContent').value = '';
            this.selectedVote = null;
            this.selectVote(null);
            this.loadComments(reportId);
        } catch (error) {
            window.Toast.error('Error al publicar: ' + error.message);
        }
    },

    async loadComments(reportId) {
        try {
            const data = await Api.get(`/comments/${reportId}`);
            const container = document.getElementById('commentsContainer');

            if (!data.comments || data.comments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-text-muted); padding: 2rem;">No hay opiniones a√∫n. ¬°S√© el primero en opinar!</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            
            data.comments.forEach(comment => {
                const voteIcon = comment.vote === 'agree' ? 'üëç' : comment.vote === 'disagree' ? 'üëé' : 'ü§∑';
                const voteColor = comment.vote === 'agree' ? '#4caf50' : comment.vote === 'disagree' ? '#f44336' : '#ff9800';
                
                html += `
                    <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 4px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <strong>${comment.userName}</strong>
                                <span style="margin-left: 10px; padding: 4px 8px; background: ${voteColor}; color: white; border-radius: 12px; font-size: 0.8rem;">
                                    ${voteIcon} ${comment.vote === 'agree' ? 'De acuerdo' : comment.vote === 'disagree' ? 'En desacuerdo' : 'Neutral'}
                                </span>
                            </div>
                            <small style="color: var(--color-text-muted);">${new Date(comment.createdAt).toLocaleDateString()}</small>
                        </div>
                        <p style="margin: 0.5rem 0;">${comment.content}</p>
                        <div style="display: flex; gap: 10px; margin-top: 0.5rem;">
                            <button onclick="window.ReportsModule.voteComment('${comment._id}', 'up')" 
                                    style="background: none; border: 1px solid #ddd; padding: 4px 12px; border-radius: 4px; cursor: pointer;">
                                üëç ${comment.upvotes || 0}
                            </button>
                            <button onclick="window.ReportsModule.voteComment('${comment._id}', 'down')" 
                                    style="background: none; border: 1px solid #ddd; padding: 4px 12px; border-radius: 4px; cursor: pointer;">
                                üëé ${comment.downvotes || 0}
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;

        } catch (error) {
            document.getElementById('commentsContainer').innerHTML = 
                `<p style="color: var(--color-error);">Error cargando opiniones</p>`;
        }
    },

    async voteComment(commentId, vote) {
        if (!window.Auth.isLoggedIn()) {
            window.Toast.warning('Debes iniciar sesi√≥n para votar');
            return;
        }

        const user = window.Auth.getUser();
        try {
            await Api.put(`/comments/${commentId}/vote`, { userId: user.userId, vote });
            window.Toast.success('Voto registrado');
            // Reload comments to show updated votes
            const reportId = window.location.hash.split('/')[2];
            this.loadComments(reportId);
        } catch (error) {
            window.Toast.error(error.message);
        }
    },
        }
    },

    translateStatus(status) {
        const map = {
            'pending': 'Pendiente',
            'verified': 'Verificado',
            'disputed': 'En Disputa',
            'rejected': 'Rechazado'
        };
        return map[status] || status;
    }
};
